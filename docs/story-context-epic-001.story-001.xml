<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-001</epicId>
    <storyId>story-001</storyId>
    <title>Setup Consolidated Sheets Tool (Phase 1)</title>
    <status>Approved</status>
    <generatedAt>2025-10-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/ossieirondi/Projects/local-mcps/gdrive/docs/Stories/story-001-setup-sheets-tool.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>MCP server developer</asA>
    <iWant>to consolidate 12 individual Sheets tools into 1 operation-based tool</iWant>
    <soThat>the LLM sees fewer tools (improved selection) and the codebase follows HOW2MCP 2025 patterns</soThat>
    <tasks>
      <task id="AC-1">Create Zod Schemas File (src/sheets/sheets-schemas.ts) with 12 operation-specific schemas using discriminated unions</task>
      <task id="AC-2">Create Operation Handler File (src/sheets/sheets-handler.ts) with router and 12 individual operation handlers</task>
      <task id="AC-3">Wire Into Main Server (index.ts) - import handler, add tool definition, add case handler</task>
      <task id="AC-4">Verify TypeScript Compilation - npm run build with no errors</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" title="Create Zod Schemas File">
      <location>src/sheets/sheets-schemas.ts</location>
      <requirements>
        <requirement>Create base schema with 'operation' discriminator</requirement>
        <requirement>Implement 12 operation-specific schemas: list, read, create, rename, delete, update, updateFormula, format, conditionalFormat, append, freeze, setColumnWidth</requirement>
        <requirement>Use Zod .refine() for either/or validation (rename/delete need sheetName OR sheetId)</requirement>
        <requirement>Export discriminated union: z.discriminatedUnion('operation', [...])</requirement>
        <requirement>Export TypeScript type: export type SheetsToolInput = z.infer&lt;typeof SheetsToolSchema&gt;</requirement>
      </requirements>
      <reference>Consolidation Guide Lines 144-264</reference>
    </criterion>
    <criterion id="AC-2" title="Create Operation Handler File">
      <location>src/sheets/sheets-handler.ts</location>
      <requirements>
        <requirement>Implement main handler: handleSheetsTool(args: any, context: { logger: Logger })</requirement>
        <requirement>Validate args with SheetsToolSchema.parse(args)</requirement>
        <requirement>Implement operation router using switch statement on validated.operation</requirement>
        <requirement>Implement 12 individual operation handlers (copy logic from existing handlers)</requirement>
        <requirement>Use TypeScript Extract&lt;&gt; utility for type-safe operation handlers</requirement>
        <requirement>Pass centralized logger to all handlers (no new logger instances)</requirement>
        <requirement>Return standard MCP response format: { content: [{ type: "text", text: "..." }] }</requirement>
      </requirements>
      <reference>Consolidation Guide Lines 401-788</reference>
    </criterion>
    <criterion id="AC-3" title="Wire Into Main Server">
      <location>index.ts</location>
      <requirements>
        <requirement>Import: import { handleSheetsTool } from './src/sheets/sheets-handler.js'</requirement>
        <requirement>Add consolidated 'sheets' tool definition to ListToolsRequestSchema handler</requirement>
        <requirement>Tool schema includes: name: "sheets", operation enum with all 12 operations, all operation-specific parameters</requirement>
        <requirement>required: ["operation", "spreadsheetId"]</requirement>
        <requirement>Add case handler in CallToolRequestSchema: case "sheets": return await handleSheetsTool(args, { logger: this.logger });</requirement>
        <requirement>Ensure single ListToolsRequestSchema handler returns ALL tools (not just sheets)</requirement>
      </requirements>
      <reference>Consolidation Guide Lines 797-956</reference>
    </criterion>
    <criterion id="AC-4" title="Verify TypeScript Compilation">
      <requirements>
        <requirement>Run npm run build</requirement>
        <requirement>No TypeScript errors</requirement>
        <requirement>Verify dist/src/sheets/sheets-schemas.js exists</requirement>
        <requirement>Verify dist/src/sheets/sheets-handler.js exists</requirement>
        <requirement>Verify dist/index.js updated</requirement>
      </requirements>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/Migration/consolidation-guide.md" title="Google Workspace MCP Consolidation Guide" section="Overview">
        <snippet>Step-by-step approach to consolidating 41+ individual tools to 5 operation-based tools following HOW2MCP best practices. Sheets consolidation maps 12 individual tools (listSheets, readSheet, createSheet, etc.) to single 'sheets' tool with operation parameter.</snippet>
      </doc>
      <doc path="docs/epics/consolidate-workspace-tools.md" title="Epic: Consolidate All Google Workspace Tools" section="Reference Architecture">
        <snippet>Correct pattern uses operation-based tools with operation parameter enum (e.g., calculator with operations: add, subtract, multiply, divide). Incorrect pattern has individual tools per operation. Key patterns: Zod discriminated unions for type safety, centralized logger (single instance), single ListTools handler to prevent overwriting.</snippet>
      </doc>
      <doc path="docs/Architecture/ARCHITECTURE.md" title="Google Drive MCP Server Architecture" section="Tools Implementation">
        <snippet>Standard tool implementation structure: 1) Input validation, 2) Performance tracking start, 3) Cache check, 4) Main operation, 5) Cache result, 6) Return MCP-formatted response, 7) Error handling with performance tracking. Response format: {content: [{type: "text", text: JSON.stringify(result)}]}</snippet>
      </doc>
      <doc path="docs/Architecture/coding-standards.md" title="Coding Standards" section="MCP-Specific Standards">
        <snippet>Tool implementation pattern requires: input validation, performance tracking (startTime), cache check with cacheManager, main operation logic, cache storage, MCP-formatted response, error handling with performance tracking flag. Use consistent error handling with try-catch, structured logging, and type guards.</snippet>
      </doc>
      <doc path="CLAUDE.md" title="Project Instructions" section="HOW2MCP Reference">
        <snippet>Critical reference: /Users/ossieirondi/projects/scratch/how2mcp/ - Definitive 2025 MCP implementation guide. Key resources: MCP_IMPLEMENTATION_GUIDE.md, MCP_ARCHITECTURE_2025.md. Example project at MCP_EXAMPLE_PROJECT/src/tools/index.ts shows operation-based tools (calculator tool with operations, data-processor tool with operations). Follow operation-based pattern, NOT individual tools per operation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="index.ts" kind="handler" lines="2023-2050" reason="Existing listSheets handler - copy logic for handleListSheets()">
        <symbol>case "listSheets"</symbol>
        <note>Located at line 2023. Contains cache check, API call to sheets.spreadsheets.get(), response formatting.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2051-2085" reason="Existing readSheet handler - copy logic for handleReadSheet()">
        <symbol>case "readSheet"</symbol>
        <note>Located at line 2051. Contains range parsing, cache check, API call to sheets.spreadsheets.values.get(), response formatting.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2086-2114" reason="Existing updateCells handler - copy logic for handleUpdateCells()">
        <symbol>case "updateCells"</symbol>
        <note>Located at line 2086. Contains validation, cache invalidation, API call to sheets.spreadsheets.values.update().</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2115-2200" reason="Existing updateCellsWithFormula handler - copy logic for handleUpdateFormula()">
        <symbol>case "updateCellsWithFormula"</symbol>
        <note>Located at line 2115. Contains formula validation, UserEnteredValue handling, batchUpdate request.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2201-2293" reason="Existing formatCells handler - copy logic for handleFormatCells()">
        <symbol>case "formatCells"</symbol>
        <note>Located at line 2201. Contains GridRange conversion, CellFormat construction, RepeatCellRequest.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2294-2349" reason="Existing addConditionalFormatting handler - copy logic for handleConditionalFormat()">
        <symbol>case "addConditionalFormatting"</symbol>
        <note>Located at line 2294. Contains BooleanRule construction, AddConditionalFormatRuleRequest.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2350-2380" reason="Existing appendRows handler - copy logic for handleAppendRows()">
        <symbol>case "appendRows"</symbol>
        <note>Located at line 2350. Contains cache invalidation, API call to sheets.spreadsheets.values.append().</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2381-2500" reason="Existing createSheet handler - copy logic for handleCreateSheet()">
        <symbol>case "createSheet"</symbol>
        <note>Located at line 2381. Contains AddSheetRequest construction with properties (title, gridProperties, tabColor).</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2501-2545" reason="Existing renameSheet handler - copy logic for handleRenameSheet()">
        <symbol>case "renameSheet"</symbol>
        <note>Located at line 2501. Contains sheetId resolution (by name or id), UpdateSheetPropertiesRequest.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2546-2583" reason="Existing deleteSheet handler - copy logic for handleDeleteSheet()">
        <symbol>case "deleteSheet"</symbol>
        <note>Located at line 2546. Contains sheetId resolution, DeleteSheetRequest.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2584-2667" reason="Existing freezeRowsColumns handler - copy logic for handleFreezeRowsColumns()">
        <symbol>case "freezeRowsColumns"</symbol>
        <note>Located at line 2584. Contains GridProperties construction, UpdateSheetPropertiesRequest.</note>
      </artifact>
      <artifact path="index.ts" kind="handler" lines="2668-2750" reason="Existing setColumnWidth handler - copy logic for handleSetColumnWidth()">
        <symbol>case "setColumnWidth"</symbol>
        <note>Located at line 2668. Contains DimensionProperties construction, UpdateDimensionPropertiesRequest.</note>
      </artifact>
      <artifact path="src/sheets/helpers.ts" kind="utility" lines="1-50" reason="Existing helper functions for A1 notation parsing, GridRange conversion">
        <symbol>columnLettersToNumber, a1RangeToGridRange, parseRangeWithSheet</symbol>
        <note>Contains GridRange interface, ParsedRange interface, helper functions for coordinate conversion. Reuse these in new handlers.</note>
      </artifact>
      <artifact path="index.ts" kind="infrastructure" lines="280" reason="Logger instance - pass to handlers">
        <symbol>const logger = winston.createLogger()</symbol>
        <note>Centralized logger created at line 280. Pass this.logger to handleSheetsTool() context.</note>
      </artifact>
      <artifact path="index.ts" kind="infrastructure" lines="435" reason="CacheManager class - use for caching">
        <symbol>class CacheManager</symbol>
        <note>Redis-based cache manager with get(), set(), delete(), invalidate() methods. Use for caching operation results.</note>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="@modelcontextprotocol/sdk" version="1.0.1" usage="MCP server implementation"/>
        <package name="googleapis" version="^144.0.0" usage="Google Sheets API v4 client"/>
        <package name="winston" version="^3.17.0" usage="Structured logging"/>
        <package name="redis" version="^5.6.1" usage="Caching infrastructure"/>
        <package name="zod" version="3.25.75" usage="✅ Available via @modelcontextprotocol/sdk - use for discriminated unions"/>
      </ecosystem>
      <ecosystem name="TypeScript">
        <package name="typescript" version="^5.6.2" usage="Type safety and compilation"/>
        <package name="@types/node" version="^22" usage="Node.js type definitions"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1" type="architecture">Follow HOW2MCP 2025 patterns: operation-based tools with discriminated unions, NOT individual tools per operation</constraint>
    <constraint id="2" type="implementation">Use Zod discriminated unions for type-safe operation routing (z.discriminatedUnion('operation', [...schemas]))</constraint>
    <constraint id="3" type="implementation">Centralized logger pattern - pass single logger instance from main server, do NOT create new logger instances in handlers</constraint>
    <constraint id="4" type="implementation">Single ListTools handler - ALL tools must be registered in ONE setRequestHandler to prevent overwriting</constraint>
    <constraint id="5" type="implementation">Standard tool structure: validation → perf tracking → cache check → operation → cache store → MCP response → error handling</constraint>
    <constraint id="6" type="code-reuse">Copy logic from existing individual tool handlers in index.ts (lines ~2000-2700), do NOT rewrite from scratch</constraint>
    <constraint id="7" type="phasing">DO NOT delete old tools yet (Story 3), DO NOT test operations yet (Story 2) - focus on creating new architecture only</constraint>
  </constraints>
  <interfaces>
    <interface name="SheetsToolInput" kind="type" source="sheets-schemas.ts">
      <signature>export type SheetsToolInput = z.infer&lt;typeof SheetsToolSchema&gt;</signature>
      <description>Discriminated union type for all 12 Sheets operations. TypeScript will infer correct types based on operation discriminator.</description>
    </interface>
    <interface name="handleSheetsTool" kind="function" source="sheets-handler.ts">
      <signature>async function handleSheetsTool(args: any, context: { logger: Logger }): Promise&lt;MCPResponse&gt;</signature>
      <description>Main entry point for consolidated sheets tool. Validates args with Zod, routes to appropriate operation handler.</description>
    </interface>
    <interface name="Logger" kind="winston" source="index.ts:280">
      <description>Winston logger instance - pass to handlers via context parameter. Do NOT create new logger instances.</description>
    </interface>
    <interface name="CacheManager" kind="class" source="index.ts:435">
      <methods>get(key: string), set(key: string, value: any), delete(key: string), invalidate(pattern: string)</methods>
      <description>Redis-based cache manager. Use for caching operation results and invalidation on write operations.</description>
    </interface>
  </interfaces>
  <tests>
    <standards>
      <framework>Jest (version ^29.7.0)</framework>
      <location>src/__tests__/ and tests/</location>
      <pattern>**/*.test.ts files for unit and integration tests</pattern>
      <note>Story 1 focuses on COMPILATION ONLY. No runtime tests required until Story 2. Verify: npm run build succeeds, TypeScript compiles without errors, dist/ files exist.</note>
    </standards>
    <locations>
      <location path="src/__tests__/sheets/" type="unit">Existing Sheets unit tests (sheets-advanced.test.ts found)</location>
      <location path="src/__tests__/integration/" type="integration">Integration tests for end-to-end workflows</location>
      <location path="tests/e2e/" type="e2e">End-to-end tests</location>
    </locations>
    <ideas>
      <idea id="test-AC-1" criterion="AC-1">Zod schema validation tests - verify operation discriminator works, test each operation schema individually</idea>
      <idea id="test-AC-2" criterion="AC-2">Handler routing tests - verify switch statement routes to correct operation handler based on operation parameter</idea>
      <idea id="test-AC-3" criterion="AC-3">Tool registration tests - verify 'sheets' tool appears in tools/list with correct schema</idea>
      <idea id="test-AC-4" criterion="AC-4">Compilation test - automated test that runs 'npm run build' and checks exit code === 0</idea>
      <note>⚠️ Story 2 will implement these tests. Story 1 only needs manual build verification.</note>
    </ideas>
  </tests>
</story-context>
