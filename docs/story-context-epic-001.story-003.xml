<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-001</epicId>
    <storyId>story-003</storyId>
    <title>Cleanup Deprecated Sheets Code (Phase 3)</title>
    <status>Ready for Development</status>
    <generatedAt>2025-10-11T14:13:18-0500</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/ossieirondi/Projects/local-mcps/gdrive/docs/Stories/story-003-cleanup-sheets-code.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>to remove all old individual Sheets tool implementations</iWant>
    <soThat>we eliminate code duplication and reduce tool count for the LLM</soThat>
    <tasks>
      - Remove Old Tool Schemas from ListToolsRequestSchema (AC-1)
      - Remove Old Tool Handlers from CallToolRequestSchema (AC-2)
      - Remove Helper Function Duplicates if any (AC-3)
      - Verify Tools List After Cleanup (AC-4)
      - Test Consolidated Tool Still Works (AC-5)
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Remove Old Tool Schemas from ListToolsRequestSchema</title>
      <description>
        - Open index.ts
        - Locate ListToolsRequestSchema handler (around line ~1400)
        - Remove tool definitions for all 12 individual Sheets tools: listSheets, readSheet, createSheet, renameSheet, deleteSheet, updateCells, updateCellsWithFormula, formatCells, addConditionalFormatting, appendRows, freezeRowsColumns, setColumnWidth
        - Verify new consolidated 'sheets' tool definition remains
        - Verify other tools (Drive, Forms, Docs, batch) remain intact
      </description>
      <reference>Consolidation Guide Lines 1086-1092</reference>
    </criterion>
    <criterion id="AC-2">
      <title>Remove Old Tool Handlers from CallToolRequestSchema</title>
      <description>
        - Open index.ts
        - Locate CallToolRequestSchema handler (around line ~1800)
        - Remove case handlers for all 12 individual Sheets tools with their complete logic blocks
        - Verify new consolidated 'sheets' case handler remains
        - Verify other tool case handlers remain intact
      </description>
    </criterion>
    <criterion id="AC-3">
      <title>Remove Helper Function Duplicates (If Any)</title>
      <description>
        - Check for any Sheets-specific helper functions that are no longer used
        - Remove duplicates if the same helpers are now in src/sheets/sheets-handler.ts
        - Keep shared helpers that are used by other tools (Drive, Forms, Docs)
        - Document any helpers that were kept vs. removed
      </description>
    </criterion>
    <criterion id="AC-4">
      <title>Verify Tools List After Cleanup</title>
      <description>
        - Run npm run build to compile changes
        - Start server: node dist/index.js
        - Use MCP Inspector to call tools/list
        - Verify output shows 'sheets' tool and other tools, but NO individual Sheets tools
        - Count total tools returned (should be significantly reduced)
      </description>
    </criterion>
    <criterion id="AC-5">
      <title>Test Consolidated Tool Still Works</title>
      <description>
        - Run a quick smoke test of the consolidated 'sheets' tool
        - Test 2-3 operations: list, read, update
        - Verify responses are identical to Story 2 testing
      </description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/Migration/consolidation-guide.md</path>
        <title>Google Workspace MCP Consolidation Guide</title>
        <section>Phase 3: Cleanup Deprecated Code</section>
        <snippet>
Lines 1086-1092: Phase 3: Cleanup Deprecated Code
- [ ] **CRITICAL**: Remove old tool files (listSheets.ts, readSheet.ts, etc.)
- [ ] **CRITICAL**: Remove old tool exports from index files
- [ ] **CRITICAL**: Verify `tools/list` doesn't show deprecated tools
- [ ] Delete old test files for individual tools
- [ ] Remove old tool registration code
        </snippet>
        <relevance>PRIMARY - This is THE authoritative guide for cleanup phase. Lines 1086-1092 define the exact checklist for this story.</relevance>
      </doc>
      <doc>
        <path>docs/Migration/consolidation-guide.md</path>
        <title>Google Workspace MCP Consolidation Guide</title>
        <section>What to Remove vs Keep</section>
        <snippet>
Lines 115-137: Expected Line Reduction
**Before Cleanup:**
- `index.ts`: ~3500 lines
- Individual tool definitions: ~300 lines (12 tools × ~25 lines each)
- Individual tool handlers: ~450 lines (12 handlers × ~35 lines each)

**After Cleanup:**
- `index.ts`: ~2750 lines
- **Total removed:** ~750 lines
        </snippet>
        <relevance>Provides quantitative targets for code removal verification</relevance>
      </doc>
      <doc>
        <path>docs/epics/consolidate-workspace-tools.md</path>
        <title>Epic: Consolidate All Google Workspace Tools</title>
        <section>Story 3 Context</section>
        <snippet>
Lines 81-85: Story 3: Cleanup Deprecated Sheets Code (Phase 3)
**Estimate:** 10 minutes
**Description:** Remove old individual tool schemas and handlers, verify tools/list
**Reference:** `docs/Migration/consolidation-guide.md` Lines 1086-1092
        </snippet>
        <relevance>Epic-level context showing this is Phase 3 of 5-phase consolidation</relevance>
      </doc>
      <doc>
        <path>docs/Stories/story-001-setup-sheets-tool.md</path>
        <title>Story 001: Setup Consolidated Sheets Tool</title>
        <section>Implementation Completed</section>
        <snippet>
Lines 1-30: Created files in Phase 1:
- src/sheets/sheets-schemas.ts - Zod schemas with discriminated unions
- src/sheets/sheets-handler.ts - Operation handler with routing
- Wired consolidated 'sheets' tool into index.ts
Status: Ready for Review (Phase 1 complete)
        </snippet>
        <relevance>Shows what was created in Story 1 that we must preserve while cleaning up old code</relevance>
      </doc>
      <doc>
        <path>docs/Architecture/coding-standards.md</path>
        <title>Coding Standards</title>
        <section>TypeScript Standards</section>
        <snippet>
Lines 6-13: General Principles
- **Type Safety First**: Always prefer explicit types over `any`
- **Strict Mode**: All TypeScript strict flags are enabled
- **ES2022 Features**: Use modern JavaScript features
- **Functional Approach**: Prefer immutability and pure functions
        </snippet>
        <relevance>Standards to maintain during code cleanup</relevance>
      </doc>
    </docs>
    <code>
      <file>
        <path>index.ts</path>
        <kind>main-server</kind>
        <lines>3906</lines>
        <reason>PRIMARY FILE TO MODIFY - Contains all old tool definitions and handlers to remove</reason>
        <details>
          Old Tool Definitions (ListToolsRequestSchema):
          - Line 1132: name: "listSheets"
          - Line 1146: name: "readSheet"
          - Line 1165: name: "updateCells"
          - Line 1459: name: "createSheet"
          - Plus 8 more tool definitions to locate and remove

          Old Case Handlers (CallToolRequestSchema):
          - Line 2229: case "listSheets"
          - Line 2257: case "readSheet"
          - Line 2292: case "updateCells"
          - Line 2321: case "updateCellsWithFormula"
          - Line 2407: case "formatCells"
          - Line 2500: case "addConditionalFormatting"
          - Line 2556: case "appendRows"
          - Line 2587: case "createSheet"
          - Line 2707: case "renameSheet"
          - Line 2752: case "deleteSheet"
          - Line 2790: case "freezeRowsColumns"
          - Line 2874: case "setColumnWidth"

          NEW Consolidated Tool TO PRESERVE:
          - Line 937: name: "sheets" (consolidated tool definition)
          - Line 2219: case "sheets" (consolidated case handler)
        </details>
      </file>
      <file>
        <path>src/sheets/sheets-handler.ts</path>
        <kind>handler</kind>
        <symbol>handleSheetsTool</symbol>
        <lines>1-50 (header)</lines>
        <reason>NEW consolidated handler - MUST PRESERVE. This is the replacement for all 12 old handlers.</reason>
      </file>
      <file>
        <path>src/sheets/sheets-schemas.ts</path>
        <kind>schemas</kind>
        <symbol>SheetsToolSchema</symbol>
        <lines>N/A</lines>
        <reason>NEW Zod schemas - MUST PRESERVE. Provides type safety for consolidated tool.</reason>
      </file>
      <file>
        <path>src/sheets/helpers.ts</path>
        <kind>utilities</kind>
        <lines>N/A</lines>
        <reason>Helper functions used by NEW consolidated handler - MUST PRESERVE. Contains: buildFieldMask, getSheetId, parseA1Notation, etc.</reason>
      </file>
      <file>
        <path>src/sheets/conditional-formatting.ts</path>
        <kind>utilities</kind>
        <lines>N/A</lines>
        <reason>Helper functions for conditional formatting - MUST PRESERVE. Used by new handler.</reason>
      </file>
      <file>
        <path>src/sheets/layoutHelpers.ts</path>
        <kind>utilities</kind>
        <lines>N/A</lines>
        <reason>Helper functions for layout operations - MUST PRESERVE. Used for freeze/column width operations.</reason>
      </file>
    </code>
    <dependencies>
      <runtime ecosystem="node">
        <package name="@modelcontextprotocol/sdk" version="1.0.1" purpose="MCP protocol implementation" />
        <package name="googleapis" version="^144.0.0" purpose="Google APIs client library" />
        <package name="winston" version="^3.17.0" purpose="Logging framework" />
        <package name="redis" version="^5.6.1" purpose="Caching layer" />
        <package name="@google-cloud/local-auth" version="^3.0.1" purpose="OAuth2 authentication" />
      </runtime>
      <dev-dependencies ecosystem="node">
        <package name="typescript" version="^5.6.2" purpose="TypeScript compiler (ES2022 target)" />
        <package name="jest" version="^29.7.0" purpose="Testing framework" />
        <package name="ts-jest" version="^29.1.2" purpose="TypeScript Jest transformer" />
        <package name="shx" version="^0.3.4" purpose="Cross-platform shell commands (chmod)" />
        <package name="eslint" version="^9.21.0" purpose="Linting" />
        <package name="@typescript-eslint/parser" version="^8.20.0" purpose="TypeScript ESLint parser" />
      </dev-dependencies>
      <build-system>
        <tool>TypeScript Compiler (tsc)</tool>
        <command>npm run build</command>
        <output>dist/</output>
        <verification>No TypeScript errors required for AC-4</verification>
      </build-system>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>preservation</type>
      <description>MUST PRESERVE: New consolidated 'sheets' tool (line 937 definition, line 2219 case handler)</description>
    </constraint>
    <constraint>
      <type>preservation</type>
      <description>MUST PRESERVE: All helper modules in src/sheets/ (helpers.ts, conditional-formatting.ts, layoutHelpers.ts, sheets-schemas.ts, sheets-handler.ts)</description>
    </constraint>
    <constraint>
      <type>preservation</type>
      <description>MUST PRESERVE: Other tools (Drive, Forms, Docs, batch) - DO NOT touch their definitions or handlers</description>
    </constraint>
    <constraint>
      <type>removal</type>
      <description>MUST REMOVE: All 12 old tool definitions from ListToolsRequestSchema (listSheets, readSheet, createSheet, renameSheet, deleteSheet, updateCells, updateCellsWithFormula, formatCells, addConditionalFormatting, appendRows, freezeRowsColumns, setColumnWidth)</description>
    </constraint>
    <constraint>
      <type>removal</type>
      <description>MUST REMOVE: All 12 old case handlers from CallToolRequestSchema (complete case blocks with all logic)</description>
    </constraint>
    <constraint>
      <type>verification</type>
      <description>TypeScript must compile without errors after removal (npm run build)</description>
    </constraint>
    <constraint>
      <type>verification</type>
      <description>tools/list must show ONLY the new 'sheets' tool, NOT the 12 old individual tools</description>
    </constraint>
    <constraint>
      <type>target</type>
      <description>Expected line reduction: ~750 lines removed from index.ts (from 3906 lines to ~3150 lines)</description>
    </constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>SheetsHandlerContext</name>
      <kind>typescript-interface</kind>
      <signature>
interface SheetsHandlerContext {
  logger: Logger;
  sheets: sheets_v4.Sheets;
  cacheManager: CacheManagerLike;
  performanceMonitor: PerformanceMonitorLike;
  startTime: number;
}
      </signature>
      <path>src/sheets/sheets-handler.ts:43-49</path>
      <usage>Passed to handleSheetsTool() in the new consolidated case handler at index.ts:2220-2226</usage>
    </interface>
    <interface>
      <name>handleSheetsTool</name>
      <kind>function</kind>
      <signature>async function handleSheetsTool(args: unknown, context: SheetsHandlerContext): Promise&lt;{content: Array&lt;{type: string, text: string}&gt;}&gt;</signature>
      <path>src/sheets/sheets-handler.ts</path>
      <usage>Main entry point for consolidated sheets tool - called from index.ts:2220</usage>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Framework: Jest (v29.7.0) with TypeScript support (ts-jest v29.1.2)

      Test Types:
      - Unit Tests: src/__tests__/**/*.test.ts (Jest-based unit tests for individual functions)
      - Integration Tests: src/__tests__/integration/**/*.test.ts (Multi-component tests)
      - E2E Tests: tests/e2e/**/*.test.ts (End-to-end behavior tests)
      - Manual Testing: MCP Inspector for interactive tool validation

      Testing Standards:
      - Build must succeed before testing (npm run build)
      - TypeScript compilation must pass (no errors)
      - MCP Inspector used for interactive tool testing
      - Manual verification of tools/list output (Story 3 AC-4)
      - Smoke testing required (2-3 operations) not full suite (Story 3 AC-5)

      Quality Gates:
      - TypeScript compilation: REQUIRED (AC-4)
      - tools/list verification: REQUIRED (AC-4 - must show ONLY new 'sheets' tool)
      - Smoke test: REQUIRED (AC-5 - test 2-3 operations work)
      - Full test suite: NOT REQUIRED for this story (was done in Story 2)
    </standards>
    <locations>
      - src/__tests__/ - Unit tests directory
      - src/__tests__/sheets/ - Sheets-specific unit tests
      - tests/e2e/ - End-to-end tests
      - MCP Inspector - Interactive testing tool (npx @modelcontextprotocol/inspector)
    </locations>
    <ideas>
      <test id="T-1" maps-to="AC-4">
        <name>Verify Tool List After Cleanup</name>
        <approach>Manual - MCP Inspector</approach>
        <steps>
          1. Build project: npm run build
          2. Start MCP Inspector: npx @modelcontextprotocol/inspector
          3. Connect to server: node dist/index.js
          4. Call tools/list
          5. Verify output shows 'sheets' tool with 12 operations
          6. Verify NO individual Sheets tools appear (listSheets, readSheet, etc.)
          7. Count total tools - should be reduced by 12
        </steps>
        <expected>Only consolidated 'sheets' tool appears, not 12 individual tools</expected>
      </test>
      <test id="T-2" maps-to="AC-5">
        <name>Smoke Test Consolidated Tool Operations</name>
        <approach>Manual - MCP Inspector</approach>
        <steps>
          1. Test 'sheets' tool with operation: "list"
          2. Test 'sheets' tool with operation: "read" (with test spreadsheet ID and range)
          3. Test 'sheets' tool with operation: "update" (with test data)
          4. Verify all 3 operations return expected success responses
          5. Verify responses match Story 2 testing results (functional compatibility)
        </steps>
        <expected>All tested operations work identically to Story 2 results</expected>
      </test>
      <test id="T-3" maps-to="AC-4">
        <name>TypeScript Compilation Verification</name>
        <approach>Automated - npm script</approach>
        <steps>
          1. Run: npm run build
          2. Verify no TypeScript errors
          3. Verify dist/ output created successfully
          4. Check for any type errors related to removed tools
        </steps>
        <expected>Clean compilation with no TypeScript errors</expected>
      </test>
      <test id="T-4" maps-to="AC-3">
        <name>Verify Line Count Reduction</name>
        <approach>Manual - wc command</approach>
        <steps>
          1. Before cleanup: wc -l index.ts (should be ~3906 lines)
          2. After cleanup: wc -l index.ts (target: ~3150 lines)
          3. Calculate reduction: should be ~750 lines removed
        </steps>
        <expected>~750 lines removed from index.ts</expected>
      </test>
    </ideas>
  </tests>
</story-context>
