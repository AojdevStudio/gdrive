<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-001</epicId>
    <storyId>story-002</storyId>
    <title>Testing & Validation of Sheets Tool (Phase 2)</title>
    <status>Ready for Development</status>
    <generatedAt>2025-10-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/ossieirondi/Projects/local-mcps/gdrive/docs/Stories/story-002-test-sheets-tool.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>QA engineer</asA>
    <iWant>to verify all 12 Sheets operations work correctly through the consolidated tool</iWant>
    <soThat>we have confidence the refactoring maintains 100% functional compatibility</soThat>
    <tasks>
      <task id="AC-1">Test all 12 operations with MCP Inspector - verify each operation returns expected MCP response</task>
      <task id="AC-2">Verify error handling for invalid operations, missing parameters, invalid IDs</task>
      <task id="AC-3">Validate response formats follow MCP standards with operation-specific data</task>
      <task id="AC-4">Verify tool registration - confirm 'sheets' tool appears in tools/list with correct schema</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" title="Test All 12 Operations with MCP Inspector">
      <operations count="12">
        <operation name="list">List all sheets in spreadsheet - verify sheet names and IDs returned</operation>
        <operation name="read">Read data from specific range - verify 2D array format</operation>
        <operation name="create">Create new sheet with title and options - verify new sheet ID</operation>
        <operation name="rename">Rename existing sheet by name or ID - verify confirmation</operation>
        <operation name="delete">Delete sheet by name or ID - verify deletion</operation>
        <operation name="update">Update cell values in range - verify row count affected</operation>
        <operation name="updateFormula">Set formula in cells - verify formula applied</operation>
        <operation name="format">Apply cell formatting (bold, colors, number formats) - verify formatting</operation>
        <operation name="conditionalFormat">Add conditional formatting rules - verify rule created</operation>
        <operation name="append">Append rows to sheet - verify rows appended</operation>
        <operation name="freeze">Freeze rows and/or columns - verify freeze applied</operation>
        <operation name="setColumnWidth">Set pixel widths for columns - verify column widths</operation>
      </operations>
      <requirement>Each operation must return MCP success response: { content: [{ type: "text", text: "..." }] }</requirement>
      <reference>Consolidation Guide Lines 979-1014, Story 002 AC-1</reference>
    </criterion>
    <criterion id="AC-2" title="Verify Error Handling">
      <errorTests>
        <test>Invalid operation name → Returns Zod validation error with helpful message</test>
        <test>Missing required parameters → Returns Zod validation error listing missing params</test>
        <test>Invalid spreadsheetId → Returns Google API error with helpful message</test>
        <test>Invalid sheet name → Returns appropriate error message</test>
        <test>Invalid range format → Returns appropriate error message</test>
        <test>All errors logged properly using centralized logger (winston)</test>
      </errorTests>
      <reference>Story 002 AC-2</reference>
    </criterion>
    <criterion id="AC-3" title="Validate Response Formats">
      <requirements>
        <requirement>Success responses follow MCP format: { content: [{ type: "text", text: "..." }] }</requirement>
        <requirement>Responses include operation-specific data (sheet IDs, cell values, confirmation messages)</requirement>
        <requirement>Responses are human-readable and informative</requirement>
      </requirements>
      <reference>Story 002 AC-3</reference>
    </criterion>
    <criterion id="AC-4" title="Verify Tool Registration">
      <requirements>
        <requirement>Run tools/list in MCP Inspector</requirement>
        <requirement>Confirm 'sheets' tool appears with name: "sheets"</requirement>
        <requirement>Tool description includes all 12 operations</requirement>
        <requirement>'operation' parameter has enum of 12 operations</requirement>
        <requirement>All operation-specific parameters listed</requirement>
        <requirement>required: ["operation", "spreadsheetId"]</requirement>
        <requirement>Old individual tools still appear (NOT removed yet - that's Story 3)</requirement>
      </requirements>
      <reference>Story 002 AC-4</reference>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/Migration/consolidation-guide.md" title="Consolidation Guide Testing Section" section="Lines 979-1014">
        <snippet>Testing instructions using MCP Inspector: npx @modelcontextprotocol/inspector node dist/index.js. Also includes JSON-RPC test commands for testing specific operations. Test by running: echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{"name":"sheets","arguments":{"operation":"list","spreadsheetId":"your-id"}}}' | node dist/index.js</snippet>
      </doc>
      <doc path="docs/Stories/story-002-test-sheets-tool.md" title="Story 002 - Testing Documentation" section="Technical Notes">
        <snippet>Contains 12 complete example test commands for each operation with JSON payloads. Includes MCP Inspector setup instructions, test spreadsheet requirements, expected behavior validation, and test report template.</snippet>
      </doc>
      <doc path="docs/Stories/story-001-setup-sheets-tool.md" title="Story 001 Implementation" section="Dev Agent Record">
        <snippet>Story 001 COMPLETED - all AC checked. Implementation created sheets-schemas.ts with Zod discriminated unions and sheets-handler.ts with operation routing. Debug log confirms build passed and files exist in dist/.</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="src/sheets/sheets-schemas.ts" kind="schema" lines="1-211" reason="Zod schemas to test - verify discriminated union validation works">
        <symbol>SheetsToolSchema, SheetsToolInput</symbol>
        <note>Created by Story 001. Contains discriminated union with 12 operation schemas. Test Zod validation: invalid operations, missing parameters, type coercion. Line 180-207: main discriminatedUnion with .refine() for either/or validation.</note>
      </artifact>
      <artifact path="src/sheets/sheets-handler.ts" kind="handler" lines="1-100+" reason="Main handler to test - verify operation routing and MCP response format">
        <symbol>handleSheetsTool, SheetsHandlerContext</symbol>
        <note>Created by Story 001. Main entry point for consolidated sheets tool. Validates with SheetsToolSchema.parse(), routes to operation handlers. Test: all 12 operations route correctly, error handling, MCP response format.</note>
      </artifact>
      <artifact path="src/__tests__/sheets/" kind="test-examples" reason="Existing test patterns to follow">
        <symbol>createSheet.test.ts, formatCells-helpers.test.ts, addConditionalFormatting.test.ts, advancedFeatures.test.ts</symbol>
        <note>Existing Jest tests for individual operations. Use as reference for test structure, mocking patterns, assertion styles. Follow same testing conventions.</note>
      </artifact>
      <artifact path="index.ts" kind="server" reason="Tool registration to verify">
        <symbol>ListToolsRequestSchema handler, CallToolRequestSchema handler</symbol>
        <note>Updated by Story 001. Check that 'sheets' tool is registered in ListToolsRequestSchema with all 12 operations. Verify CallToolRequestSchema has case "sheets" that calls handleSheetsTool.</note>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Node.js">
        <package name="@modelcontextprotocol/sdk" version="1.0.1" usage="MCP server implementation - provides protocol types and schemas"/>
        <package name="@modelcontextprotocol/inspector" version="latest" usage="⚠️ TEST TOOL: Install with npx for interactive testing"/>
        <package name="googleapis" version="^144.0.0" usage="Google Sheets API v4 - operations call this"/>
        <package name="zod" version="3.25.75" usage="Schema validation - test Zod error handling"/>
        <package name="winston" version="^3.17.0" usage="Logging - verify error logs appear"/>
      </ecosystem>
      <ecosystem name="Testing">
        <package name="jest" version="^29.7.0" usage="Test framework - Story 002 uses manual MCP Inspector testing"/>
        <package name="@types/jest" version="^29.5.12" usage="Jest type definitions"/>
        <package name="ts-jest" version="^29.1.2" usage="TypeScript support for Jest"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1" type="testing">Use MCP Inspector for manual end-to-end testing - DO NOT write Jest unit tests for Story 002</constraint>
    <constraint id="2" type="testing">Create a dedicated test Google Spreadsheet - DO NOT use production data</constraint>
    <constraint id="3" type="scope">Test ONLY the new consolidated 'sheets' tool - DO NOT test old individual tools</constraint>
    <constraint id="4" type="validation">Verify ALL 12 operations work identically to old tools - 100% functional compatibility required</constraint>
    <constraint id="5" type="error-handling">Test error cases: invalid operations, missing params, bad IDs, invalid ranges</constraint>
    <constraint id="6" type="response-format">Every success response must follow MCP format: { content: [{ type: "text", text: "..." }] }</constraint>
    <constraint id="7" type="prerequisites">Story 001 must be COMPLETE with npm run build successful before testing</constraint>
  </constraints>
  <interfaces>
    <interface name="SheetsToolSchema" kind="zod" source="sheets-schemas.ts:180-207">
      <signature>z.discriminatedUnion('operation', [12 schemas]).refine(either/or validation)</signature>
      <description>Main Zod schema for consolidated sheets tool. Validates operation parameter and routes to correct operation schema. Test: invalid operation names, missing parameters, type coercion.</description>
    </interface>
    <interface name="SheetsHandlerContext" kind="type" source="sheets-handler.ts:43-49">
      <signature>{ logger: Logger, sheets: sheets_v4.Sheets, cacheManager: CacheManagerLike, performanceMonitor: PerformanceMonitorLike, startTime: number }</signature>
      <description>Context passed to handler functions. Contains logger (winston), sheets API client, cache manager, performance monitor. Verify logger is used for all operations.</description>
    </interface>
    <interface name="handleSheetsTool" kind="function" source="sheets-handler.ts">
      <signature>async function handleSheetsTool(args: any, context: SheetsHandlerContext): Promise&lt;MCPResponse&gt;</signature>
      <description>Main entry point for consolidated sheets tool. Parses args with SheetsToolSchema, routes to operation handlers. Test: call with all 12 operations, verify routing works, check error handling.</description>
    </interface>
    <interface name="MCPResponse" kind="type" source="MCP SDK">
      <signature>{ content: [{ type: "text" | "image" | "resource", text?: string, data?: string, mimeType?: string }] }</signature>
      <description>Standard MCP response format. All operations must return this format. Verify: response.content is array, first item has type="text", text field contains operation result.</description>
    </interface>
  </interfaces>
  <tests>
    <standards>
      <approach>Manual End-to-End Testing with MCP Inspector</approach>
      <tool>MCP Inspector - npx @modelcontextprotocol/inspector node dist/index.js</tool>
      <alternative>JSON-RPC via stdin - echo '{"jsonrpc":"2.0","id":2,"method":"tools/call","params":{...}}' | node dist/index.js</alternative>
      <framework>Jest (^29.7.0) available but NOT used for Story 002 - manual testing only</framework>
      <validation>
        <step>1. Start MCP Inspector connected to built server</step>
        <step>2. Run tools/list to verify 'sheets' tool registration</step>
        <step>3. Execute each of 12 operations with test spreadsheet</step>
        <step>4. Verify success responses match MCP format</step>
        <step>5. Test error cases (invalid params, bad IDs)</step>
        <step>6. Document results in test report template</step>
      </validation>
      <note>Story 002 uses manual testing to validate implementation works end-to-end. Unit tests can be added later if needed.</note>
    </standards>
    <locations>
      <location path="src/__tests__/sheets/" type="reference">Existing Jest test examples for individual operations - reference for future unit tests</location>
      <location path="docs/Stories/story-002-test-sheets-tool.md" type="documentation">Complete testing documentation with 12 example commands, setup instructions, test report template</location>
      <location path="dist/" type="build">Compiled server to test - verify npm run build creates dist/index.js, dist/src/sheets/*.js</location>
    </locations>
    <ideas>
      <idea id="test-AC-1-operations" criterion="AC-1">
        <title>Test All 12 Operations Successfully</title>
        <steps>
          <step>1. list: Verify returns array of sheets with names and IDs</step>
          <step>2. read: Verify returns 2D array of cell values from range</step>
          <step>3. create: Verify creates new sheet, returns sheet ID</step>
          <step>4. rename: Test by sheetName and by sheetId, verify rename works</step>
          <step>5. delete: Test by sheetName and by sheetId, verify deletion</step>
          <step>6. update: Verify cell values updated, returns row count</step>
          <step>7. updateFormula: Verify formula set, cell computes correctly</step>
          <step>8. format: Verify bold, colors, number formats applied</step>
          <step>9. conditionalFormat: Verify rule added, cells highlight correctly</step>
          <step>10. append: Verify rows appended to end of sheet</step>
          <step>11. freeze: Verify rows/columns frozen in UI</step>
          <step>12. setColumnWidth: Verify column widths changed in UI</step>
        </steps>
        <testData>Test spreadsheet with: 2+ sheets, sample data (text, numbers, formulas), various cell types</testData>
      </idea>
      <idea id="test-AC-2-errors" criterion="AC-2">
        <title>Verify Error Handling</title>
        <tests>
          <test>Invalid operation: {"operation": "invalid", "spreadsheetId": "..."} → Zod error</test>
          <test>Missing spreadsheetId: {"operation": "list"} → Zod error "spreadsheetId required"</test>
          <test>Missing range for read: {"operation": "read", "spreadsheetId": "..."} → Zod error "range required"</test>
          <test>Invalid spreadsheetId: {"operation": "list", "spreadsheetId": "bad-id"} → Google API error</test>
          <test>Invalid sheetName: {"operation": "delete", "spreadsheetId": "...", "sheetName": "DoesNotExist"} → Error message</test>
          <test>Check console logs for winston error logging</test>
        </tests>
      </idea>
      <idea id="test-AC-3-formats" criterion="AC-3">
        <title>Validate MCP Response Formats</title>
        <checks>
          <check>All success responses have: response.content (array)</check>
          <check>First content item has: type="text"</check>
          <check>First content item has: text field (string)</check>
          <check>Response text is human-readable (not raw JSON)</check>
          <check>Response includes operation-specific data (IDs, values, confirmations)</check>
        </checks>
      </idea>
      <idea id="test-AC-4-registration" criterion="AC-4">
        <title>Verify Tool Registration</title>
        <steps>
          <step>1. Run tools/list in MCP Inspector</step>
          <step>2. Find 'sheets' in tools array</step>
          <step>3. Check inputSchema has 'operation' with enum of 12 operations</step>
          <step>4. Check required array includes ["operation", "spreadsheetId"]</step>
          <step>5. Verify all operation-specific params listed (range, values, format, etc.)</step>
          <step>6. Confirm old tools still present (listSheets, readSheet, etc.) - not removed yet</step>
        </steps>
      </idea>
      <idea id="test-smoke" criterion="ALL">
        <title>Smoke Test - Quick Validation</title>
        <quickTest>
          <step>1. npm run build (verify no errors)</step>
          <step>2. Start server: node dist/index.js</step>
          <step>3. Test list operation: verify returns sheets</step>
          <step>4. Test read operation: verify returns data</step>
          <step>5. If these work, full test suite likely works</step>
        </quickTest>
      </idea>
      <idea id="test-regression" criterion="ALL">
        <title>Regression Testing</title>
        <comparison>Compare new consolidated tool responses with old individual tool responses (if saved). Verify: same data returned, same error messages, same behavior.</comparison>
        <note>Old tools still exist in Story 002 - can test both and compare if needed</note>
      </idea>
    </ideas>
  </tests>
</story-context>
