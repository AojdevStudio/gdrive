<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-001</epicId>
    <storyId>story-005</storyId>
    <title>Repeat Pattern for Drive, Forms, Docs (Phase 5)</title>
    <status>Ready for Development</status>
    <generatedAt>2025-10-11</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/ossieirondi/Projects/local-mcps/gdrive/docs/Stories/story-005-repeat-pattern-drive-forms-docs.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>development team</asA>
    <iWant>to apply the proven Sheets consolidation pattern to Drive, Forms, and Docs</iWant>
    <soThat>we complete the full 41+ → 5 tools refactoring efficiently</soThat>
    <tasks>
      - Phase 1 (Parallel): Create schemas and handlers for Drive, Forms, and Docs (3 tracks simultaneously)
      - Phase 2 (Sequential): Wire each consolidated tool into index.ts ListToolsRequestSchema
      - Phase 3 (Parallel): Test all operations for Drive (7), Forms (4), and Docs (5)
      - Phase 4 (Parallel): Remove old individual tool definitions and handlers from index.ts
      - Final Verification: Ensure tools/list shows exactly 5 tools, all operations work correctly
    </tasks>
  </story>

  <acceptanceCriteria>
    - AC-1: Drive consolidation complete with 7 operations (search, enhancedSearch, read, create, update, createFolder, batch)
    - AC-2: Forms consolidation complete with 4 operations (create, read, addQuestion, listResponses)
    - AC-3: Docs consolidation complete with 5 operations (create, insertText, replaceText, applyTextStyle, insertTable)
    - AC-4: All operations tested end-to-end using MCP Inspector
    - AC-5: Old individual tool schemas and handlers removed from index.ts
    - AC-6: tools/list shows exactly 5 consolidated tools (sheets, drive, forms, docs, plus any non-consolidated tools)
    - AC-7: TypeScript compilation successful with no errors
    - AC-8: Total tool count reduced from 41+ to ~5-8 tools (88% reduction achieved)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/Migration/consolidation-guide.md</path>
        <title>Google Workspace MCP Consolidation Guide</title>
        <section>Lines 1-1117 - Complete implementation guide for consolidating 41+ tools to 5 operation-based tools</section>
        <snippet>Provides step-by-step instructions for implementing Zod schemas, operation handlers, centralized tool registration, and the complete pattern for Drive, Forms, and Docs consolidation following HOW2MCP 2025 best practices.</snippet>
      </doc>
      <doc>
        <path>docs/epics/consolidate-workspace-tools.md</path>
        <title>Epic: Consolidate All Google Workspace Tools to Operation-Based Architecture</title>
        <section>Lines 1-234 - Epic overview and reference architecture</section>
        <snippet>Defines the epic vision (41+ → 5 tools), success criteria, parallel execution strategy for Story 5, and the HOW2MCP reference pattern with operation-based tool architecture.</snippet>
      </doc>
      <doc>
        <path>/Users/ossieirondi/projects/scratch/how2mcp/GOOGLE_WORKSPACE_CONSOLIDATION_GUIDE.md</path>
        <title>HOW2MCP Google Workspace Consolidation Reference</title>
        <section>Lines 1-1117 - Authoritative MCP 2025 patterns</section>
        <snippet>Reference implementation showing operation-based tools, discriminated unions, centralized logger pattern, single ListTools handler, and proper MCP SDK integration.</snippet>
      </doc>
      <doc>
        <path>docs/Architecture/ARCHITECTURE.md</path>
        <title>Google Drive MCP Server Architecture</title>
        <section>Lines 1-1280 - System architecture and component design</section>
        <snippet>Describes MCP server layer, authentication architecture, caching infrastructure, request handlers, and the current tool implementation (22 tools) that needs consolidation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/sheets/sheets-schemas.ts</path>
        <kind>module</kind>
        <symbol>SheetsToolSchema, SheetsListSchema, SheetsReadSchema, etc.</symbol>
        <lines>1-200+</lines>
        <reason>Reference pattern for creating Drive/Forms/Docs schemas - shows Zod discriminated union pattern, operation enums, and proper validation</reason>
      </artifact>
      <artifact>
        <path>src/sheets/sheets-handler.ts</path>
        <kind>module</kind>
        <symbol>handleSheetsTool, SheetsHandlerContext</symbol>
        <lines>1-500+</lines>
        <reason>Reference pattern for operation routing and handler implementation - shows switch statement routing, error handling, and integration with logger/cache/performance monitor</reason>
      </artifact>
      <artifact>
        <path>index.ts</path>
        <kind>main-server</kind>
        <symbol>case "sheets":</symbol>
        <lines>1642-1648</lines>
        <reason>Shows how consolidated tool is wired into CallToolRequestSchema handler - pattern to replicate for drive/forms/docs</reason>
      </artifact>
      <artifact>
        <path>index.ts</path>
        <kind>main-server</kind>
        <symbol>import { handleSheetsTool }</symbol>
        <lines>21</lines>
        <reason>Import pattern to follow for new handlers</reason>
      </artifact>
      <artifact>
        <path>index.ts</path>
        <kind>main-server</kind>
        <symbol>ListToolsRequestSchema handler</symbol>
        <lines>1400-1800 (estimated)</lines>
        <reason>Where consolidated tool definitions must be added for Drive, Forms, and Docs - currently has old individual tools that need to be replaced</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="zod" version="^3.22.0">Validation library for runtime type checking and schema definition</package>
        <package name="googleapis" version="latest">Google APIs client library providing drive_v3, sheets_v4, docs_v1, forms_v1</package>
        <package name="@modelcontextprotocol/sdk" version="latest">MCP SDK for server implementation</package>
        <package name="winston" version="latest">Structured logging library</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>CRITICAL: Must follow HOW2MCP 2025 operation-based pattern exactly - one tool per service with operation parameter, NOT individual tools per operation</constraint>
    <constraint>Must use Zod discriminated unions for type-safe operation validation (z.discriminatedUnion)</constraint>
    <constraint>Must implement centralized logger pattern - pass logger from main server context, do NOT create new logger instances in handlers</constraint>
    <constraint>Must register ALL tools in single ListToolsRequestSchema handler to prevent overwriting</constraint>
    <constraint>All tool schemas must use JSON Schema format in ListToolsRequestSchema, NOT Zod (Zod is for runtime validation only)</constraint>
    <constraint>Must implement operation routing with switch statement in handler</constraint>
    <constraint>Must integrate with existing cacheManager and performanceMonitor instances</constraint>
    <constraint>File structure: src/{service}/{service}-schemas.ts and src/{service}/{service}-handler.ts (following Sheets pattern)</constraint>
    <constraint>Parallel execution for Phase 1 (setup) and Phase 3 (testing) - sequential for Phase 2 (wiring) to avoid merge conflicts</constraint>
    <constraint>Must remove old individual tool definitions AND handlers after consolidation (cleanup phase)</constraint>
    <constraint>All stderr logging only - NEVER use stdout (reserved for JSON-RPC responses)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>SheetsHandlerContext</name>
      <kind>interface</kind>
      <signature>{ logger: Logger; sheets: sheets_v4.Sheets; cacheManager: CacheManagerLike; performanceMonitor: PerformanceMonitorLike; startTime: number }</signature>
      <path>src/sheets/sheets-handler.ts:43-49</path>
      <reason>Pattern to replicate for Drive/Forms/Docs handler contexts - shows required dependencies passed from main server</reason>
    </interface>
    <interface>
      <name>handleSheetsTool</name>
      <kind>function</kind>
      <signature>async function handleSheetsTool(args: unknown, context: SheetsHandlerContext): Promise&lt;ToolResponse&gt;</signature>
      <path>src/sheets/sheets-handler.ts</path>
      <reason>Handler function signature pattern - validates args with Zod, routes to operation handlers, returns MCP-compatible response</reason>
    </interface>
    <interface>
      <name>Google APIs</name>
      <kind>external-api</kind>
      <signature>drive_v3.Drive, forms_v1.Forms, docs_v1.Docs from googleapis package</signature>
      <path>index.ts (imported from googleapis)</path>
      <reason>Google API clients that handlers will call - already initialized in main server, pass as context</reason>
    </interface>
  </interfaces>

  <tests>
    <standards>Use MCP Inspector for end-to-end testing of all operations. Each operation must be tested with valid inputs and error cases. Test framework: MCP Inspector CLI tool for interactive testing. Pattern: Test each operation individually, verify response format matches MCP specification, check error handling for invalid inputs.</standards>
    <locations>
      - MCP Inspector: npx @modelcontextprotocol/inspector node dist/index.js
      - Integration tests: src/__tests__/integration/ (follow existing patterns)
      - Unit tests: src/__tests__/{service}/ (create new directories for drive, forms, docs)
    </locations>
    <ideas>
      <test ac="AC-1" desc="Drive search operation">Test natural language search query parsing and Drive API integration</test>
      <test ac="AC-1" desc="Drive enhancedSearch operation">Test advanced filters (mimeType, modifiedAfter, ownedByMe, etc.)</test>
      <test ac="AC-1" desc="Drive read operation">Test file content reading with format conversion (Docs→Markdown, Sheets→CSV)</test>
      <test ac="AC-2" desc="Forms create operation">Test form creation with title and description</test>
      <test ac="AC-2" desc="Forms addQuestion operation">Test all question types (TEXT, MULTIPLE_CHOICE, LINEAR_SCALE, etc.)</test>
      <test ac="AC-3" desc="Docs create operation">Test document creation with initial content</test>
      <test ac="AC-3" desc="Docs insertText operation">Test text insertion at specific index</test>
      <test ac="AC-3" desc="Docs replaceText operation">Test find/replace with matchCase option</test>
      <test ac="AC-6" desc="tools/list verification">Verify exactly 5 tools returned, no old individual tools appear</test>
      <test ac="AC-8" desc="Tool count regression test">Automated test that fails if tool count exceeds 8 (88% reduction)</test>
    </ideas>
  </tests>
</story-context>
