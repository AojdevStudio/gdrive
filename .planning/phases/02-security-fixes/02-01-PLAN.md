---
phase: 02-security-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/drive/search.ts
  - src/modules/drive/__tests__/search.test.ts
autonomous: true

must_haves:
  truths:
    - "Search queries with single quotes do not break API calls"
    - "Search queries with injection attempts are treated as literal strings"
    - "Both search and enhancedSearch functions escape user input consistently"
  artifacts:
    - path: "src/modules/drive/search.ts"
      provides: "escapeQueryValue function and updated search functions"
      contains: "replace(/'/g, \"\\\\'\")"
    - path: "src/modules/drive/__tests__/search.test.ts"
      provides: "Security tests for query injection prevention"
      min_lines: 80
  key_links:
    - from: "src/modules/drive/search.ts"
      to: "Google Drive API"
      via: "Escaped query string in files.list"
      pattern: "escapeQueryValue"
---

<objective>
Fix Google Drive search query injection vulnerability by escaping single quotes in user input (SEC-01).

Purpose: User input containing single quotes is directly interpolated into Drive API queries without escaping. This can break query structure or cause unexpected behavior. Google's official documentation requires backslash escaping for single quotes.

Output: Updated search functions with query escaping and comprehensive security tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-security-fixes/02-RESEARCH.md

# Source file to modify
@src/modules/drive/search.ts

# Test pattern reference
@src/__tests__/security/key-security.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add escapeQueryValue function and update search functions</name>
  <files>
    src/modules/drive/search.ts
  </files>
  <action>
1. Add the `escapeQueryValue` helper function near the top of the file (after imports, before SearchOptions interface):

```typescript
/**
 * Escape special characters for Google Drive query language
 * Google Drive API requires backslash escaping for single quotes
 * @see https://developers.google.com/workspace/drive/api/guides/ref-search-terms
 * @param value User input to escape
 * @returns Escaped string safe for query interpolation
 */
function escapeQueryValue(value: string): string {
  return value.replace(/'/g, "\\'");
}
```

2. Update the `search` function (around line 63):
   - Change: `q: \`name contains '\${query}' and trashed = false\``
   - To: `q: \`name contains '\${escapeQueryValue(query)}' and trashed = false\``

3. Update the `enhancedSearch` function (around line 169):
   - Change: `let q = query ? \`name contains '\${query}'\` : "";`
   - To: `let q = query ? \`name contains '\${escapeQueryValue(query)}'\` : "";`

4. Also update filter conditions that use user input in `enhancedSearch`:
   - Line ~174: `filterConditions.push(\`mimeType = '\${escapeQueryValue(filters.mimeType)}'\`);`
   - Line ~195: `filterConditions.push(\`'\${escapeQueryValue(filters.parents)}' in parents\`);`

Note: Date fields (modifiedAfter, modifiedBefore, etc.) use ISO 8601 format which shouldn't contain quotes, but the mimeType and parents fields could contain user input that needs escaping.
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles without errors.
  </verify>
  <done>
- `escapeQueryValue` function exists with JSDoc comment
- `search` function uses `escapeQueryValue(query)` in query string
- `enhancedSearch` function uses `escapeQueryValue(query)` in query string
- Filter conditions for mimeType and parents use escaping
- Build passes with no TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Drive search security tests</name>
  <files>
    src/modules/drive/__tests__/search.test.ts
  </files>
  <action>
Create test directory and file:

1. Create directory `src/modules/drive/__tests__/` if it doesn't exist

2. Create `search.test.ts` following the security test pattern from `key-security.test.ts`:

```typescript
/**
 * Security tests for Drive search query escaping
 */

import { describe, test, expect, beforeEach, jest } from '@jest/globals';
import { search, enhancedSearch } from '../search.js';

describe('Drive Search Security', () => {
  let mockContext: any;
  let mockDriveApi: any;

  beforeEach(() => {
    mockDriveApi = {
      files: {
        list: jest.fn().mockResolvedValue({
          data: { files: [] }
        }),
      },
    };

    mockContext = {
      drive: mockDriveApi,
      cacheManager: {
        get: jest.fn().mockResolvedValue(null),
        set: jest.fn().mockResolvedValue(undefined),
      },
      performanceMonitor: {
        track: jest.fn(),
      },
      startTime: Date.now(),
    };
  });

  describe('search - query escaping', () => {
    test('escapes single quotes in search queries', async () => {
      await search({ query: "John's Document" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: "name contains 'John\\'s Document' and trashed = false"
        })
      );
    });

    test('handles multiple single quotes', async () => {
      await search({ query: "It's O'Brien's file" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: "name contains 'It\\'s O\\'Brien\\'s file' and trashed = false"
        })
      );
    });

    test('prevents query structure manipulation', async () => {
      // Attack vector: try to inject additional query terms
      await search({ query: "test' or name contains '" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: "name contains 'test\\' or name contains \\'' and trashed = false"
        })
      );
    });

    test('handles strings without quotes unchanged', async () => {
      await search({ query: "normal query" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: "name contains 'normal query' and trashed = false"
        })
      );
    });

    test('handles empty string', async () => {
      await search({ query: "" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: "name contains '' and trashed = false"
        })
      );
    });
  });

  describe('enhancedSearch - query escaping', () => {
    test('escapes single quotes in query parameter', async () => {
      await enhancedSearch({ query: "John's Report" }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: expect.stringContaining("name contains 'John\\'s Report'")
        })
      );
    });

    test('escapes single quotes in mimeType filter', async () => {
      await enhancedSearch({
        filters: { mimeType: "test'injection" }
      }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: expect.stringContaining("mimeType = 'test\\'injection'")
        })
      );
    });

    test('escapes single quotes in parents filter', async () => {
      await enhancedSearch({
        filters: { parents: "folder'id" }
      }, mockContext);

      expect(mockDriveApi.files.list).toHaveBeenCalledWith(
        expect.objectContaining({
          q: expect.stringContaining("'folder\\'id' in parents")
        })
      );
    });

    test('combines query and filter escaping', async () => {
      await enhancedSearch({
        query: "O'Brien",
        filters: { mimeType: "text/plain" }
      }, mockContext);

      const call = mockDriveApi.files.list.mock.calls[0][0];
      expect(call.q).toContain("name contains 'O\\'Brien'");
      expect(call.q).toContain("mimeType = 'text/plain'");
    });
  });
});
```
  </action>
  <verify>
Run `npm test -- --testPathPattern="drive.*search"` to verify tests pass.
  </verify>
  <done>
- Test file exists at `src/modules/drive/__tests__/search.test.ts`
- Tests cover single quote escaping in search function
- Tests cover injection attempt prevention
- Tests cover enhancedSearch with query and filters
- All tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   npm run build
   ```
   Should complete with no errors.

2. **Test verification:**
   ```bash
   npm test -- --testPathPattern="drive.*search"
   ```
   All Drive search security tests should pass.

3. **Manual verification:**
   - Review `src/modules/drive/search.ts` - escapeQueryValue function exists
   - Verify `search` function calls escapeQueryValue on query
   - Verify `enhancedSearch` function calls escapeQueryValue on query and filters
</verification>

<success_criteria>
- [ ] `escapeQueryValue` function exists with proper JSDoc
- [ ] `search` function escapes query before interpolation
- [ ] `enhancedSearch` function escapes query and relevant filters
- [ ] Security tests exist covering injection scenarios
- [ ] All tests pass including new security tests
- [ ] `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-fixes/02-01-SUMMARY.md`
</output>
