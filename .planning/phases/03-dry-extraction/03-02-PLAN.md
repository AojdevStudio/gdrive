---
phase: 03-dry-extraction
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/modules/calendar/read.ts
  - src/modules/calendar/create.ts
  - src/modules/calendar/update.ts
autonomous: true

must_haves:
  truths:
    - "No parseAttendees function defined in read.ts, create.ts, or update.ts"
    - "No inline EventResult building code in read.ts, create.ts, or update.ts"
    - "All calendar operations produce identical results as before refactoring"
    - "All existing calendar tests pass"
  artifacts:
    - path: "src/modules/calendar/read.ts"
      provides: "getCalendar and getEvent using shared utilities"
      imports: ["parseAttendees", "buildEventResult"]
    - path: "src/modules/calendar/create.ts"
      provides: "createEvent and quickAdd using shared utilities"
      imports: ["parseAttendees", "buildEventResult"]
    - path: "src/modules/calendar/update.ts"
      provides: "updateEvent using shared utilities"
      imports: ["parseAttendees", "buildEventResult"]
  key_links:
    - from: "src/modules/calendar/read.ts"
      to: "./utils.js"
      via: "Import statement"
      pattern: "import.*buildEventResult.*from.*utils"
    - from: "src/modules/calendar/create.ts"
      to: "./utils.js"
      via: "Import statement"
      pattern: "import.*buildEventResult.*from.*utils"
    - from: "src/modules/calendar/update.ts"
      to: "./utils.js"
      via: "Import statement"
      pattern: "import.*buildEventResult.*from.*utils"
---

<objective>
Update calendar consumer files to import from utils.ts and remove duplicate implementations.

Purpose: Complete the DRY extraction by removing all duplicate parseAttendees and EventResult building code from consumer files, replacing with imports from calendar/utils.ts.

Output:
- Updated `src/modules/calendar/read.ts` using buildEventResult
- Updated `src/modules/calendar/create.ts` using buildEventResult
- Updated `src/modules/calendar/update.ts` using buildEventResult
- Zero duplicate implementations remaining
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dry-extraction/03-01-SUMMARY.md (created in Plan 01)

Key source files to modify:
@src/modules/calendar/read.ts (remove local parseAttendees, replace getEvent result building)
@src/modules/calendar/create.ts (remove local parseAttendees, replace createEvent and quickAdd result building)
@src/modules/calendar/update.ts (remove local parseAttendees, replace updateEvent result building)
@src/modules/calendar/utils.ts (provides parseAttendees and buildEventResult)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update read.ts to use shared utilities</name>
  <files>src/modules/calendar/read.ts</files>
  <action>
Modify src/modules/calendar/read.ts to:

1. Update imports at top of file - add buildEventResult to utils import:
```typescript
import { buildEventResult } from './utils.js';
```

2. REMOVE the local parseAttendees function (lines 88-122, the function starting with `function parseAttendees`).

3. In getEvent function, REPLACE the result building code (lines 164-276, from `const result: EventResult = {` through the reminders block) with a single call to buildEventResult:

BEFORE (lines 162-276):
```typescript
  const response = await context.calendar.events.get(params);

  const result: EventResult = {
    eventId: response.data.id!,
  };
  // ... ~110 lines of property assignments ...
```

AFTER:
```typescript
  const response = await context.calendar.events.get(params);

  const result = buildEventResult(response.data);
```

4. Keep all the caching, logging, and return statement that follows.

The rest of the file (getCalendar function, imports, etc.) remains unchanged.

CRITICAL:
- Do NOT remove the Attendee type import - it may be needed elsewhere
- Keep all context operations (cacheManager, performanceMonitor, logger)
- The buildEventResult call replaces ~110 lines of code
  </action>
  <verify>
Run: `npm run build` - should compile without errors
Run: `grep -n "function parseAttendees" src/modules/calendar/read.ts` - should return NO results
Run: `grep -n "buildEventResult" src/modules/calendar/read.ts` - should show import and usage
  </verify>
  <done>read.ts uses buildEventResult from utils, local parseAttendees removed</done>
</task>

<task type="auto">
  <name>Task 2: Update create.ts to use shared utilities</name>
  <files>src/modules/calendar/create.ts</files>
  <action>
Modify src/modules/calendar/create.ts to:

1. Update imports at top of file - add buildEventResult to existing utils import:
```typescript
import { validateEventTimes, buildEventResult } from './utils.js';
```

2. REMOVE the local parseAttendees function (lines 20-61, the function after the validateEventTimes import).

3. In createEvent function, REPLACE the result building code (lines 244-357, from `const result: EventResult = {` through the reminders block) with:
```typescript
  const result = buildEventResult(response.data);
```

4. In quickAdd function, REPLACE the result building code (lines 425-537, from `const result: EventResult = {` through the reminders block) with:
```typescript
  const result = buildEventResult(response.data);
```

5. Keep all the cache invalidation, logging, and return statements.

6. Note: The `parsedAttendees` variable reference in logging (line 373) needs to change:
   BEFORE: `attendeeCount: parsedAttendees?.length || 0,`
   AFTER: `attendeeCount: result.attendees?.length || 0,`

CRITICAL:
- Keep the Attendee type import for the resolvedAttendees typing
- Keep all context operations
- Each buildEventResult call replaces ~110 lines of code
  </action>
  <verify>
Run: `npm run build` - should compile without errors
Run: `grep -n "function parseAttendees" src/modules/calendar/create.ts` - should return NO results
Run: `grep -c "buildEventResult" src/modules/calendar/create.ts` - should show 3 (1 import + 2 usages)
  </verify>
  <done>create.ts uses buildEventResult from utils for both createEvent and quickAdd, local parseAttendees removed</done>
</task>

<task type="auto">
  <name>Task 3: Update update.ts to use shared utilities</name>
  <files>src/modules/calendar/update.ts</files>
  <action>
Modify src/modules/calendar/update.ts to:

1. Update imports at top of file - add buildEventResult to existing utils import:
```typescript
import { validateEventTimes, buildEventResult } from './utils.js';
```

2. REMOVE the local parseAttendees function (lines 19-60, the function after the validateEventTimes import).

3. In updateEvent function, REPLACE the result building code (lines 231-344, from `const result: EventResult = {` through the reminders block) with:
```typescript
  const result = buildEventResult(response.data);
```

4. Keep all the cache invalidation, logging, and return statements.

CRITICAL:
- Keep the Attendee type import
- Keep all context operations
- The buildEventResult call replaces ~110 lines of code
  </action>
  <verify>
Run: `npm run build` - should compile without errors
Run: `grep -n "function parseAttendees" src/modules/calendar/update.ts` - should return NO results
Run: `grep -c "buildEventResult" src/modules/calendar/update.ts` - should show 2 (1 import + 1 usage)
  </verify>
  <done>update.ts uses buildEventResult from utils, local parseAttendees removed</done>
</task>

</tasks>

<verification>
1. Run full build: `npm run build` - must pass
2. Run all calendar tests: `npm test -- --testPathPattern="calendar"` - all tests pass
3. Verify no duplicate parseAttendees: `grep -r "function parseAttendees" src/modules/calendar/` - only shows utils.ts
4. Verify buildEventResult usage: `grep -r "buildEventResult" src/modules/calendar/` - shows utils.ts + 4 consumers (read, create x2, update)
5. Count removed lines: should be ~450 lines removed total (3 parseAttendees + 4 result builders)
</verification>

<success_criteria>
- No local parseAttendees function in read.ts, create.ts, or update.ts
- No inline EventResult building in consumer files
- All calendar module tests pass
- Code compiles without TypeScript errors
- DRY-01 and DRY-02 requirements fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-dry-extraction/03-02-SUMMARY.md`
</output>
