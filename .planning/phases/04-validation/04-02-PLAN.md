---
phase: 04-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/calendar/validation.ts
  - src/modules/calendar/__tests__/validation.test.ts
  - src/modules/calendar/read.ts
  - src/modules/calendar/list.ts
  - src/modules/calendar/freebusy.ts
  - src/modules/calendar/utils.ts
autonomous: true

must_haves:
  truths:
    - "Calendar operations throw descriptive errors when API response fields are missing"
    - "Error messages include operation name and input identifiers"
    - "FreeBusy responses validate time ranges and busy periods"
    - "Empty arrays are returned for list operations, not thrown errors"
  artifacts:
    - path: "src/modules/calendar/validation.ts"
      provides: "Assertion functions for Calendar API validation"
      exports: ["assertRequiredString"]
    - path: "src/modules/calendar/__tests__/validation.test.ts"
      provides: "Unit tests for Calendar validation helpers"
      min_lines: 50
  key_links:
    - from: "src/modules/calendar/read.ts"
      to: "src/modules/calendar/validation.ts"
      via: "import { assertRequiredString }"
      pattern: "import.*assertRequiredString.*from.*validation"
    - from: "src/modules/calendar/freebusy.ts"
      to: "src/modules/calendar/validation.ts"
      via: "import and validation calls"
      pattern: "import.*from.*validation"
    - from: "src/modules/calendar/utils.ts"
      to: "src/modules/calendar/validation.ts"
      via: "import for buildEventResult"
      pattern: "import.*from.*validation"
---

<objective>
Create Calendar validation utilities and replace non-null assertions with proper runtime validation.

Purpose: Eliminate runtime risks from non-null assertions (`!`) in Calendar module by adding explicit validation with descriptive error messages, improving debuggability for AI agents consuming the API.

Output:
- `validation.ts` with assertion functions following TypeScript patterns
- Updated Calendar operations using validation instead of `!`
- Tests covering null/undefined API response scenarios
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation/04-CONTEXT.md
@.planning/phases/04-validation/04-RESEARCH.md
@src/modules/calendar/read.ts
@src/modules/calendar/list.ts
@src/modules/calendar/freebusy.ts
@src/modules/calendar/utils.ts
@src/modules/calendar/__tests__/list.test.ts
@src/modules/calendar/__tests__/freebusy.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Calendar validation utilities</name>
  <files>src/modules/calendar/validation.ts, src/modules/calendar/__tests__/validation.test.ts</files>
  <action>
Create `src/modules/calendar/validation.ts` with assertion functions:

1. `assertRequiredString(value, fieldName, operationName, ...contextArgs)`:
   - Uses TypeScript `asserts` keyword for type narrowing
   - Throws descriptive error when value is null/undefined
   - Error format: `"${operationName}: ${fieldName} is ${null|undefined} for ${context}"`
   - Example: `"getEvent: response.id is undefined for eventId='abc123'"`

Note: This is the same pattern as Gmail validation, but separate module to keep dependencies clean.

Create `src/modules/calendar/__tests__/validation.test.ts` with tests:
- `assertRequiredString` throws on null
- `assertRequiredString` throws on undefined
- `assertRequiredString` passes on valid string
- `assertRequiredString` error message includes context
- `assertRequiredString` error message includes operation name

Follow existing test patterns from `list.test.ts` or `freebusy.test.ts`.
  </action>
  <verify>`npm test -- --testPathPattern="calendar.*validation"` passes all tests</verify>
  <done>
- `validation.ts` exports `assertRequiredString`
- All 5+ tests pass
- Error messages follow the format specified in CONTEXT.md
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace non-null assertions in Calendar operations</name>
  <files>src/modules/calendar/read.ts, src/modules/calendar/list.ts, src/modules/calendar/freebusy.ts, src/modules/calendar/utils.ts</files>
  <action>
Replace all non-null assertions (`!`) with proper validation in Calendar module files.

**read.ts** (line 54):
- Import `assertRequiredString` from `./validation.js`
- In `getCalendar`: Replace `response.data.id!` with validation
- Context: `getCalendar` with calendarId parameter

**list.ts** (lines 74, 195):
- Import `assertRequiredString` from `./validation.js`
- In `listCalendars` map: Replace `cal.id!` with validation
  - Context: `listCalendars` with note about array index
- In `listEvents` map: Replace `event.id!` with validation
  - Context: `listEvents` with calendarId parameter

**freebusy.ts** (lines 68, 69, 80, 81, 89, 90):
- Import `assertRequiredString` from `./validation.js`
- `response.data.timeMin!` and `response.data.timeMax!`: Validate before use
  - Context: `checkFreeBusy` with timeMin/timeMax from request
- `period.start!` and `period.end!`: Validate in map callback
  - Context: `checkFreeBusy` with calendar ID
- `err.domain!` and `err.reason!`: Validate in error map
  - Context: `checkFreeBusy` error handling

**utils.ts** (line 113):
- Import `assertRequiredString` from `./validation.js`
- In `buildEventResult`: Replace `responseData.id!` with validation
  - Context: `buildEventResult` (internal function, context passed from caller)

For all replacements:
- Validate BEFORE using the value
- Use nullish coalescing `?? []` for arrays that are already handled (keep existing pattern)
- Maintain existing exactOptionalPropertyTypes compliance
  </action>
  <verify>
- `npm run build` compiles without errors
- `npm test` passes all existing tests
- No `!` assertions remain on API response fields in modified files (grep check)
  </verify>
  <done>
- All `!` assertions on API response fields replaced with validation calls
- Build passes, all tests pass
- TypeScript properly narrows types after validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for Calendar validation scenarios</name>
  <files>src/modules/calendar/__tests__/freebusy.test.ts</files>
  <action>
Add test cases to existing `freebusy.test.ts` for validation error scenarios:

1. Test: `throws descriptive error when timeMin is undefined in response`
   - Mock API to return response with `timeMin: undefined`
   - Expect: throws Error with message containing "checkFreeBusy" and "timeMin"

2. Test: `throws descriptive error when timeMax is undefined in response`
   - Mock API to return response with `timeMax: undefined`
   - Expect: throws Error with message containing "checkFreeBusy" and "timeMax"

3. Test: `handles missing busy periods gracefully`
   - Mock API to return calendar with `busy: undefined`
   - Expect: returns empty busy array (not throw)

These tests verify the validation without testing every assertion (which validation.test.ts covers).

Follow existing test patterns in the file.
  </action>
  <verify>`npm test -- --testPathPattern="freebusy.test"` passes all tests including new ones</verify>
  <done>
- New tests for API response validation added
- Tests verify error message content and context
- All tests pass (new + existing)
  </done>
</task>

</tasks>

<verification>
Run full verification after all tasks:

```bash
# Build check
npm run build

# Run Calendar tests
npm test -- --testPathPattern="calendar"

# Verify no remaining non-null assertions in modified files
grep -n '\.id!' src/modules/calendar/read.ts src/modules/calendar/list.ts src/modules/calendar/freebusy.ts src/modules/calendar/utils.ts || echo "No remaining id assertions - PASS"
grep -n 'timeMin!' src/modules/calendar/freebusy.ts || echo "No remaining timeMin assertions - PASS"
grep -n 'timeMax!' src/modules/calendar/freebusy.ts || echo "No remaining timeMax assertions - PASS"
grep -n 'start!' src/modules/calendar/freebusy.ts || echo "No remaining start assertions - PASS"
grep -n 'end!' src/modules/calendar/freebusy.ts || echo "No remaining end assertions - PASS"

# Verify validation.ts is imported
grep -l "from.*validation" src/modules/calendar/read.ts src/modules/calendar/list.ts src/modules/calendar/freebusy.ts src/modules/calendar/utils.ts
```
</verification>

<success_criteria>
- VAL-02: All Calendar non-null assertions replaced with runtime validation
- All existing Calendar tests pass (no regressions)
- New validation tests pass
- Build compiles cleanly
- Descriptive error messages include operation context
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-02-SUMMARY.md`
</output>
