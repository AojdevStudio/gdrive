---
phase: 04-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/gmail/validation.ts
  - src/modules/gmail/__tests__/validation.test.ts
  - src/modules/gmail/read.ts
  - src/modules/gmail/list.ts
  - src/modules/gmail/search.ts
  - src/modules/gmail/labels.ts
autonomous: true

must_haves:
  truths:
    - "Gmail operations throw descriptive errors when API response fields are missing"
    - "Error messages include operation name and input identifiers"
    - "modifyLabels throws error when both addLabelIds and removeLabelIds are empty"
    - "Empty arrays are returned for list operations, not thrown errors"
  artifacts:
    - path: "src/modules/gmail/validation.ts"
      provides: "Assertion functions for Gmail API validation"
      exports: ["assertRequiredString", "assertNonEmptyArray"]
    - path: "src/modules/gmail/__tests__/validation.test.ts"
      provides: "Unit tests for validation helpers"
      min_lines: 80
  key_links:
    - from: "src/modules/gmail/read.ts"
      to: "src/modules/gmail/validation.ts"
      via: "import { assertRequiredString }"
      pattern: "import.*assertRequiredString.*from.*validation"
    - from: "src/modules/gmail/labels.ts"
      to: "src/modules/gmail/validation.ts"
      via: "import and no-op validation"
      pattern: "import.*from.*validation"
---

<objective>
Create Gmail validation utilities and replace non-null assertions with proper runtime validation.

Purpose: Eliminate runtime risks from non-null assertions (`!`) in Gmail module by adding explicit validation with descriptive error messages, improving debuggability for AI agents consuming the API.

Output:
- `validation.ts` with assertion functions following TypeScript patterns
- Updated Gmail operations using validation instead of `!`
- Tests covering null/undefined API response scenarios
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation/04-CONTEXT.md
@.planning/phases/04-validation/04-RESEARCH.md
@src/modules/gmail/read.ts
@src/modules/gmail/list.ts
@src/modules/gmail/search.ts
@src/modules/gmail/labels.ts
@src/modules/gmail/__tests__/labels.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gmail validation utilities</name>
  <files>src/modules/gmail/validation.ts, src/modules/gmail/__tests__/validation.test.ts</files>
  <action>
Create `src/modules/gmail/validation.ts` with assertion functions:

1. `assertRequiredString(value, fieldName, operationName, ...contextArgs)`:
   - Uses TypeScript `asserts` keyword for type narrowing
   - Throws descriptive error when value is null/undefined
   - Error format: `"${operationName}: ${fieldName} is ${null|undefined} for ${context}"`
   - Example: `"getMessage: response.id is undefined for messageId='abc123'"`

2. `assertModifyLabelsOperation(addLabelIds, removeLabelIds)`:
   - Throws error when BOTH arrays are empty/missing (no-op is invalid)
   - Error format: `"modifyLabels: at least one of addLabelIds or removeLabelIds must be provided"`
   - Does NOT throw if at least one array has items

Create `src/modules/gmail/__tests__/validation.test.ts` with tests:
- `assertRequiredString` throws on null
- `assertRequiredString` throws on undefined
- `assertRequiredString` passes on valid string
- `assertRequiredString` error message includes context
- `assertModifyLabelsOperation` throws when both empty
- `assertModifyLabelsOperation` passes when addLabelIds has items
- `assertModifyLabelsOperation` passes when removeLabelIds has items
- `assertModifyLabelsOperation` passes when both have items

Follow existing test patterns from `labels.test.ts`.
  </action>
  <verify>`npm test -- --testPathPattern="validation.test"` passes all tests</verify>
  <done>
- `validation.ts` exports `assertRequiredString` and `assertModifyLabelsOperation`
- All 8+ tests pass
- Error messages follow the format specified in CONTEXT.md
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace non-null assertions in Gmail operations</name>
  <files>src/modules/gmail/read.ts, src/modules/gmail/list.ts, src/modules/gmail/search.ts, src/modules/gmail/labels.ts</files>
  <action>
Replace all non-null assertions (`!`) with proper validation in Gmail module files.

**read.ts** (lines 114, 115, 232):
- Import `assertRequiredString` from `./validation.js`
- In `parseMessage`: Replace `message.id!` and `message.threadId!` with validation
- In `getThread`: Replace `response.data.id!` with validation
- Pass context: operation name and input ID

**list.ts** (lines 71, 72, 150):
- Import `assertRequiredString` from `./validation.js`
- In `listMessages` map: Replace `msg.id!` and `msg.threadId!` with validation
  - Context: `listMessages` with note about array index
- In `listThreads` map: Replace `thread.id!` with validation
  - Context: `listThreads` with note about array index

**search.ts** (lines 76, 77):
- Import `assertRequiredString` from `./validation.js`
- In `searchMessages` map: Replace `msg.id!` and `msg.threadId!` with validation
  - Context: `searchMessages` with query parameter

**labels.ts** (lines 50, 51, plus VAL-03):
- Import `assertRequiredString` and `assertModifyLabelsOperation` from `./validation.js`
- In `listLabels` map: Replace `label.id!` and `label.name!` with validation
- In `modifyLabels`: Add `assertModifyLabelsOperation(addLabelIds, removeLabelIds)` at start of function (BEFORE API call)

For all replacements:
- Validate BEFORE using the value (not at API boundary)
- Use nullish coalescing `?? []` for arrays that are already handled (keep existing pattern)
- Log validation errors at error level if they occur
  </action>
  <verify>
- `npm run build` compiles without errors
- `npm test` passes all existing tests
- No `!` assertions remain on API response fields in modified files (grep check)
  </verify>
  <done>
- All `!` assertions on API response fields replaced with validation calls
- `modifyLabels` throws error when both arrays are empty (VAL-03)
- Build passes, all tests pass
- TypeScript properly narrows types after validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for validation error scenarios</name>
  <files>src/modules/gmail/__tests__/labels.test.ts</files>
  <action>
Add test cases to existing `labels.test.ts` for the VAL-03 validation:

1. Test: `throws error when both addLabelIds and removeLabelIds are empty`
   - Call `modifyLabels({ id: '123', addLabelIds: [], removeLabelIds: [] }, context)`
   - Expect: throws Error with message containing "at least one of addLabelIds or removeLabelIds"

2. Test: `throws error when both addLabelIds and removeLabelIds are undefined`
   - Call `modifyLabels({ id: '123' }, context)` (no label arrays)
   - Expect: throws Error with message containing "at least one of addLabelIds or removeLabelIds"

3. Test: `succeeds when only addLabelIds provided`
   - Verify existing tests cover this (should already pass)

4. Test: `succeeds when only removeLabelIds provided`
   - Verify existing tests cover this (should already pass)

Follow existing test patterns in the file.
  </action>
  <verify>`npm test -- --testPathPattern="labels.test"` passes all tests including new ones</verify>
  <done>
- New tests for empty label validation added
- Tests verify error message content
- All tests pass (new + existing)
  </done>
</task>

</tasks>

<verification>
Run full verification after all tasks:

```bash
# Build check
npm run build

# Run Gmail tests
npm test -- --testPathPattern="gmail"

# Verify no remaining non-null assertions in modified files
grep -n '\.id!' src/modules/gmail/read.ts src/modules/gmail/list.ts src/modules/gmail/search.ts src/modules/gmail/labels.ts || echo "No remaining assertions - PASS"

# Verify validation.ts is imported
grep -l "from.*validation" src/modules/gmail/read.ts src/modules/gmail/list.ts src/modules/gmail/search.ts src/modules/gmail/labels.ts
```
</verification>

<success_criteria>
- VAL-01: All Gmail non-null assertions replaced with runtime validation
- VAL-03: modifyLabels throws when no label operations provided
- All existing Gmail tests pass (no regressions)
- New validation tests pass
- Build compiles cleanly
- Descriptive error messages include operation context
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation/04-01-SUMMARY.md`
</output>
